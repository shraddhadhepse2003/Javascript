$(function() {
    'use strict';
    var apiKey = null;
    var nativeAgentId = null;
    var nativeDepartmentId = null;
    var nativeDepartmentName = null;
    var sessionId = null;
    var session = null;
    var token = null;
    var tokenJsonObj = null;
    var enableVideo = false;
    var enableAudio = true;
    var isCallDisconnectedByMe = false;
    var publisher = null;
    var callTimeout = null;
    var w = window;
    var d = document;
    var client;
    var socket = null;
    var lcAppointmentDate = null;
    var lcAppointmentTime = null;
    var appId = $('#app_id').val();
    var userId = $('#b_uid').val();
    var avatar = $('#avatar').val();
    var transportProtocol = $('#transportProtocol').val();
    var botChatBackground = $('#bot_chat_background').val();
    var botChatColor = $('#bot_chat_color').val();
    var userChatBackground = $('#user_chat_background').val();
    var userChatColor = $('#user_chat_color').val();
    var chatHeaderColorLeft = $('#chat_header_color_left').val();
    var chatHeaderColorRight = $('#chat_header_color_right').val();
    var chatSize = $('#chat_size').val();
    var welcomeMessage = $('#welcome_message').val();
    var isWelcomeEventCall = $('#is_welcome_event_call').val();
    var welcomeEventName = $('#welcome_event_name').val();
    var botifyHostName = window.location.hostname + ((window.location.port) ? ":" + location.port : "");
    var isResetState = false;
    var isAppVideoCall = false;
    var isSockJSInit = false;
    var messages = {};
    var loadHistory = '<div class="lc-load-history"><div id="load-history" class="lc-load-inner">Load History</div></div>';
    var loading = ' <div id="loading" class="lc-message lc-message-received"> ' + ((avatar) ? ' <div class="lc-message-avatar"> <img src="' + avatar + '" alt="Logo" /></div> ' : '') + ' <div class="lc-message-content"><div class="lc-message-bubble"><div class="lc-message-text"><p><span class="lc-etc"><i></i><i></i><i></i></span></p></div></div></div></div>';
    var disableTextbox = false;
    var hostUrl = document.referrer;
    var hostCookies = [];
    var repeatedMessage = false;
    var isMinimized = false;
    var preview = false;
    var previewWorkflowId = 0;

    if (appId == null || botifyHostName == null) {
        return;
    }
    //if this script gets loaded successfully means it is an impression.
    callAnalytics("Impression");
    $(":root")[0].style.setProperty('--gradient', 'linear-gradient(90deg, ' + chatHeaderColorLeft + ' 0%, ' + chatHeaderColorRight + ' 100%)');
    $(":root")[0].style.setProperty('--botChatBackground', botChatBackground);
    $(":root")[0].style.setProperty('--botChatColor', botChatColor);
    $(":root")[0].style.setProperty('--userChatBackground', userChatBackground);
    $(":root")[0].style.setProperty('--userChatColor', userChatColor);
    $(":root")[0].style.setProperty('--chatHeaderColorLeft', chatHeaderColorLeft);
    $(":root")[0].style.setProperty('--chatHeaderColorRight', chatHeaderColorRight);
    $(":root")[0].style.setProperty('--userChatActive', hexToRgbA(userChatBackground, 0.070));

    $('.lc-start-video-call').click(function() {
        sendMessage('Initiate video call', 'CALL', 'VIDEO_CALL', true);
        isAppVideoCall = true;
        resetStream();
    });    
    
    $(".lc-file-btn").click(function(){
        $('.lc-file-input').trigger("click");        
    });

    $(".lc-file-input").change(function(){
        var fileName = $(".lc-file-input").prop('files')[0]["name"];
        var file = $(".lc-file-input").prop('files')[0];
        var formData = new FormData();
        formData.append("file", file);
        var ext = fileName.split('.').pop().toLowerCase();
        if ($.inArray(ext, ['gif', 'png', 'jpg', 'jpeg', 'pdf', 'xls', 'xlsx', 'doc', 'docx', 'ppt', 'pptx', 'txt', 'csv', 'mp4', 'avi', 'flv', 'mkv']) == -1) {
        	showFileUploadMsg("Error: File type is not supported");  
        	$(".lc-file-input").val(null);
            return;
        }
        var size = $(".lc-file-input").prop('files')[0].size;
        if(size > 104857600) {
        	showFileUploadMsg("File size is too big: Max limit is 100 MB");  
        	$(".lc-file-input").val(null);
            return;           
        }

        $.ajax({
            type: 'POST',
            url: w.location.protocol + '//' + botifyHostName + '/api/v1/livechat/file-upload/' + appId + '/' + userId,
            data: formData,
            contentType: false,
            cache: false,
            processData: false,
            error: function(jqXHR, exception) {            	
            	showFileUploadMsg(JSON.stringify(exception)); 
            },
            success: function(data) {
                if (data.result != null && data.status == 200) {                	 
                	 sendMessage(createJSON('file-upload', fileName, data.result), 'TEXT', 'SEND_MESSAGE', false);
                } else {
                	showFileUploadMsg("error while uploading file, please try again " + data.status);                	
                }             
            }
        });
        
        $(".lc-file-input").val(null);
    }); 
    
    function showFileUploadMsg(msg) {
    	$(".lc-alert-box").empty();
    	$(".lc-alert-box").html(msg);
    	$(".lc-alert-box").show();
    	$('.lc-alert-box').delay(5000).fadeOut();     
    }

    $('.lc-start-audio-call').click(function() {
        sendMessage('Initiate audio call', 'CALL', 'AUDIO_CALL', true);
    });

    if (isMobile()) {
        $('.lc-camera-flip').show();
    }

    // device detection
    function isMobile() {
        if (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent) ||
            /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0, 4))) {
            return true;
        } else {
            return false;
        }
    }

    function hexToRgbA(hex, opacity){
        var c;
        if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)){
            c= hex.substring(1).split('');
            if(c.length== 3){
                c= [c[0], c[0], c[1], c[1], c[2], c[2]];
            }
            c= '0x'+c.join('');
            return 'rgba('+[(c>>16)&255, (c>>8)&255, c&255].join(',')+','+opacity+')';
        }
        throw new Error('Bad Hex');
    }

    function disconnectVideoCall() {
        isCallDisconnectedByMe = true;
        updateVideoChatLog('disconnect');
        resetStream();
    }
    function startVideoCall() {
        $('#lc-messages-chat-page').hide();
        $('#videos').show();
        $("#lc-connecting").fadeIn();
        initVideoCall();
        playConnectingAudio();
        $("#lc-dealer-name").text(nativeDepartmentName);
    }

    // On/Off Camera
    $(d).on("click", ".lc-video-camera", function() {
        cameraOnOff();
    });

    // On/Off Audio
    $(d).on("click", ".lc-microphone", function() {
        audioOnOff();
    });

    // Disconnect Video Chat
    $(d).on("click", ".lc-phone-disconnect", function() {
        isCallDisconnectedByMe = true;
        updateVideoChatLog('disconnect');
        resetStream();
        disconnectAgent();
        
    });

    $(d).on("click", "#videocall", function() {
        initVideoCall();
    });

    $(d).on("click", ".lc-close-video", function() {
        resetStream();
        if (!isAppVideoCall) {
            lcCloseIframe();
        }
    });

    $(d).on("click", ".lc-close-iframe", function() {
        isMinimized = true;
        lcCloseIframe();
    });

    $(d).on("click", ".lc-camera-flip", function() {
        if (publisher != null) {
            publisher.cycleVideo();
        }
    });

    $(d).on("click", ".lc-drag", function() {
        var icon = $(this).data("icon");
        if (icon == 'up') {
            $(".lc-up-icon").hide();
            $(".lc-down-icon").show();
            $('.lc-welfixed-bottom').css({
                'top': 'auto'
            });
            $('.lc-welinner-box').removeClass("fadeInDown");
            $('.lc-welinner-box').addClass("fadeInUp");
            $(this).data("icon", "down");
        } else {
            $(".lc-down-icon").hide();
            $(".lc-up-icon").show();
            $('.lc-welfixed-bottom').css({
                'top': '85%'
            });
            $('.lc-welinner-box').removeClass("fadeInUp");
            $('.lc-welinner-box').addClass("fadeInDown");
            $(this).data("icon", "up");
        }
    });

    function updateVideoChatLog(event) {
        if (sessionId != null) {
            var disconnectedByUser = "customer";
            if (!isCallDisconnectedByMe) {
                disconnectedByUser = "agent";
            }
            var http = new XMLHttpRequest()
            var url = window.location.protocol + '//' + botifyHostName + '/api/v1/videochat/update-videochat-log?sessionId=' + sessionId + '&event=' + event + '&user=' + disconnectedByUser;
            http.open("GET", url);
            http.send();
        }
    }

    function updateAgentStaus(status) {
        if (nativeAgentId != null) {
            var http = new XMLHttpRequest()
            var url = window.location.protocol + '//' + botifyHostName + '/api/v1/agent/update-videochat-status?native_agent_id=' + nativeAgentId + '&status=' + status;
            http.open("GET", url);
            http.send();
        }
    }

    function handleError(error) {
        if (error) {
            updateAgentStaus('available');
            console.log(error.message);
        }
    }

    function initVideoCall() {
        var http = new XMLHttpRequest()
        var url = window.location.protocol + '//' + botifyHostName + '/api/v1/videochat/gettoken?appId=' + appId + '&uid=' + userId;
        if (nativeDepartmentId) {
            url += '&nativeDepartmentId=' + nativeDepartmentId;
        }
        http.open("GET", url);
        http.send();

        http.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                var tokenJsonResponse = http.responseText;
                console.log(tokenJsonResponse)
                tokenJsonObj = JSON.parse(tokenJsonResponse);
                sessionStorage.setItem('tokenJsonObj', JSON.stringify(tokenJsonObj.result))
                apiKey = tokenJsonObj.result.api_key;
                sessionId = tokenJsonObj.result.session_id;
                token = tokenJsonObj.result.token;
                nativeAgentId = tokenJsonObj.result.native_agent_id;
                initializeSession();
            } else if (this.readyState == 4 && this.status != 200) {
                console.log(http.responseText);
                var responseJson = JSON.parse(http.responseText);
                showAlertMessage(responseJson.error);
            }
        };
    }

    function initializeSession() {
        session = OT.initSession(apiKey, sessionId);
        callTimeout = setTimeout(resetStream, 60000);
        pauseConnectingAudio();
        publisherNotOnCall();
        $(".lc-call-msg").text("ringing...");
        // Subscribe to a newly created stream
        session.on('streamCreated', function(event) {
            clearTimeout(callTimeout);
            publisherOnCall();
            session.subscribe(event.stream, 'subscriber', {
                insertMode: 'append',
                width: '100%',
                height: '100%'
            }, handleError);
        });

        session.on("streamDestroyed", function(event) {
            resetStream();
            console.log("streamDestroyed " + event.stream.name + " ended. " + event.reason);
        });

        session.on("connectionDestroyed", function(event) {
            showAlertMessage('Dealer has disconnected the call. Please try again after some time');
            console.log("connectionDestroyed " + event.reason);
        });

        session.on("sessionDisconnected", function(event) {
            console.log("sessionDisconnected " + event.reason);
            if (event.reason === 'networkDisconnected') {
                showAlertMessage('You have lost your internet connection. Please check your connection and try again.');
            } else {
                resetStream();
            }
            pauseConnectingAudio();
            pauseRingAudio();
            $('#videos').hide();
            $('#lc-messages-chat-page').show();
        });

        // Create a publisher
        publisher = OT.initPublisher('publisher', {
            insertMode: 'append',
            width: '100%',
            height: '100%',
            publishAudio: true,
            publishVideo: false
        }, handleError);

        session.connect(token, function(error) {
            //If the connection is successful, initialize a publisher and publish to the session
            if (error) {
                handleError(error);
            } else {
                session.publish(publisher, handleError);
                connectToAgent();
            }
        });

    }

    function disconnectAgent() {
        var http = new XMLHttpRequest()
        var url = window.location.protocol + '//' + botifyHostName + '/api/v1/videochat/disconnect-agent';
        http.open("POST", url, true);
        http.setRequestHeader("Content-Type", "application/json");
        var body = sessionStorage.getItem('tokenJsonObj');
        console.log(body)
        http.send(body);

        http.onreadystatechange = function() {
            if (this.readyState == 4 && this.status != 200) {
                console.log(http.responseText);
                var responseJson = JSON.parse(http.responseText);
                showAlertMessage(responseJson.error);
            }
        };
        sessionStorage.removeItem('tokenJsonObj');
    }

    function connectToAgent() {
        playRingAudio();
        var http = new XMLHttpRequest()
        var url = window.location.protocol + '//' + botifyHostName + '/api/v1/videochat/connect-agent';
        http.open("POST", url, true);
        http.setRequestHeader("Content-Type", "application/json");
        console.log(tokenJsonObj.result)
        http.send(JSON.stringify(tokenJsonObj.result));

        http.onreadystatechange = function() {
            if (this.readyState == 4 && this.status != 200) {
                console.log(http.responseText);
                var responseJson = JSON.parse(http.responseText);
                showAlertMessage(responseJson.error);
            }
        };
    }

    function showAlertMessage(msg) {
        $(".lc-alert-text").text(msg);
        $("#lc-alert").show().delay(5000).fadeOut();
        pauseConnectingAudio();
        pauseRingAudio();
        setTimeout(function() {
            resetStream();
        }, 5000);
    }

    function resetStream() {
        updateVideoChatLog('disconnect');
        updateAgentStaus('available');
        if (session != null) {
            if (publisher != null) {
                session.unpublish(publisher);
            }
            session.disconnect();
        }
        $("#lc-connected").hide();
        $('#publisher').fadeOut();
        $('#subscriber').fadeOut();
        $('#videos').hide();
        $('#lc-messages-chat-page').show();
        enableVideo = false;
        enableAudio = true;
        isCallDisconnectedByMe = false;
        pauseConnectingAudio();
        pauseRingAudio();
        disableCamera();
        enableMicrophone();
        apiKey = null;
        nativeAgentId = null;
        nativeDepartmentId = null;
        nativeDepartmentName = null;
        sessionId = null;
        session = null;
        token = null;
        tokenJsonObj = null;
        publisher = null;
        $("#lc-connecting").fadeOut();
        $('#lc-on-call-buttons').fadeOut();
        $(".lc-call-msg").text("calling...");
    }

    function publisherOnCall() {
        pauseRingAudio();
        $('#lc-on-call-buttons').fadeIn();
        $("#lc-connected").show();
        $("#lc-connecting").fadeOut();
        $('#publisher').fadeIn();
        $('#subscriber').fadeIn();
        $("#publisher").removeClass("publisher-not-on-call");
        $("#publisher").addClass("publisher-on-call");
    }

    function publisherNotOnCall() {
        $("#publisher").removeClass("publisher-on-call");
        $("#publisher").addClass("publisher-not-on-call");
    }

    function enableCamera() {
        $('.lc-video-slash-solid').hide();
        $('.lc-video-solid').show();
    }

    function disableCamera() {
        $('.lc-video-solid').hide();
        $('.lc-video-slash-solid').show();
    }

    function enableMicrophone() {
        $('.lc-microphone-slash').hide();
        $('.lc-microphone-solid').show();
    }

    function disableMicrophone() {
        $('.lc-microphone-solid').hide();
        $('.lc-microphone-slash').show();
    }

    function playConnectingAudio() {
        callRingAlert("PLAY_CONNECTING_RING");
    }

    function playRingAudio() {
        callRingAlert("PLAY_RINGING");
    }

    function pauseConnectingAudio() {
        callRingAlert("PAUSE_CONNECTING_RING");
    }

    function pauseRingAudio() {
        callRingAlert("PAUSE_RINGING");
    }

    function cameraOnOff() {
        if (enableVideo) {
            if (publisher != null) {
                publisher.publishVideo(false);
            }
            enableVideo = false;
            disableCamera();
        } else {
            if (publisher != null) {
                publisher.publishVideo(true);
            }
            enableVideo = true;
            enableCamera();
        }
    }

    function audioOnOff() {
        if (enableAudio) {
            if (publisher != null) {
                publisher.publishAudio(false);
            }
            enableAudio = false;
            disableMicrophone();
        } else {
            if (publisher != null) {
                publisher.publishAudio(true);
            }
            enableAudio = true;
            enableMicrophone();
        }
    }

    function connectSockJS(callback) {
        if (!isSockJSInit) {
            initWebsocket();
            initNetworkEvents();
            connectToWebsocket(callback);
        } else {
            if (typeof (callback) == 'function') {
                callback();
            }
        }
    }

    function initNetworkEvents() {
        window.addEventListener('offline', function() {
            console.log("you are offline!");
        });
        window.addEventListener('online', function() {
            console.log("you are online now :)");
            socket.close();
        });
    }

    function initWebsocket() {
        if (!transportProtocol) {
            socket = new SockJS('/livechat');
        } else {
            var transportProtocolList = transportProtocol.split(",");
            socket = new SockJS('/livechat', null, { transports: transportProtocolList });
        }
        client = Stomp.over(socket);
        client.heartbeat.outgoing = 0;
        client.heartbeat.incoming = 0;
        client.debug = null;
        console.log('StompClient - ', client);
    }

    // When Select cta button is clicked, that card is selected. If chat is opened in two or more tab/window
    // with carousel open and the user selects a card from one tab, than calling this function when response
    // is received will ensure that card is selected and Select cta is disabled in each tab/window.
    function selectIfCarouselResponse(msgBody) {
        if (isCarouselExists() && msgBody && msgBody.liveChatMessageInfo
            && isJSONValid(msgBody.liveChatMessageInfo.text)
            && JSON.parse(msgBody.liveChatMessageInfo.text).control_name == "carousel") {
                var messageText = JSON.parse(msgBody.liveChatMessageInfo.text);
                var ctaBtn = $(".carousel-list:last").find('a[value="' + messageText.selected_values[0].value + '"]');
                var listItem = $(ctaBtn).closest('li.carousel-list-item');
                if (!listItem.hasClass('lc-selected')) {
                    listItem.addClass('lc-selected');
                }
        }
    }

    function connectToWebsocket(callback) {
        client.connect({ 'ack': 'client-individual' }, function(frame) {
            console.log('Websocket connection established...');
            isSockJSInit = true;
            client.subscribe('/topic/' + appId + "-" + userId, function(message) {
                message.ack();
                resetDataControl();
                var msgBody = JSON.parse(message.body);
                selectIfCarouselResponse(msgBody);
                showMessage(msgBody);
            }, { 'ack': 'client-individual' });
            if (typeof (callback) == 'function') {
                callback();
            }
            // Start all the subscriptions
        }, function(error) {
            isSockJSInit = false;
            console.log("Web socket error", error);
            reConnectWebSocket();
        });

    }

    function reConnectWebSocket() {
        console.log('Re-connecting websocket after', 2000, 'millis...')
        // Call the websocket connect method
        setTimeout(function() { initWebsocket(); connectToWebsocket(); }, 2000);
    }

    function showMessage(msg) {
        if (msg.incoming == true) {
            $('#lc-chat-window').append(showTextMessage(msg));
            callAnalytics("Incoming Message");
            scrollHeight();
        } else {
            if (msg.data_control == 'typing_delay') {
                manageTextBox(true);
                showLoading();
                setTimeout(() => {
                    hideLoading();
                }, msg.typing_delay);
            } else {
                var uuid = uuidv4();
                msg.uuid = uuid;
                messages[uuid] = msg;
                try {
                    localStorage.setItem("last_outgoing_msg_" + appId, JSON.stringify(msg));
                } catch (err) {
                    console.log('Cannot write outgoing msg in local storage');
                }
                callAnalytics("Outgoing Message");
                manageTextBox(msg.is_workflow_message);
                if(msg.is_workflow_message){
                	$(".lc-file-upload-panel").hide();
                } else {
                	$(".lc-file-upload-panel").show();
                }
                disableTextbox = (msg.is_workflow_message && !msg.is_last_node);
                hideLoading();
                if(!repeatedMessage) {
                    showOutgoingMessage(msg);
                    callRingAlert("MSG_RECEIVED");
                }
                scrollHeight();
                switch (msg.data_control) {
                    case "button":
                        showButton(msg);
                        break;
                    case "multi-button":
                        showMultiButton(msg);
                        break;
                    case "file-upload":
                        showFileUpload(msg);
                        break;
                    case "multi-select":
                        showMultiSelectionList(msg);
                        break;
                    case "single-select":
                        showSingleSelectionList(msg);
                        break;
                    case "name":
                    case "full-name":
                        showFullName(msg);
                        break;
                    case "address":
                        showAddress(msg);
                        break;
                    case "password":
                        showPassword(msg);
                        break;
                    case "email":
                        showEmail(msg);
                        break;
                    case "number":
                        showNumber(msg);
                        break;
                    case "telephone":
                    case "mobile-number":
                        showMobileNumber(msg);
                        break;
                    case "date":
                        showDate(msg);
                        break;
                    case "time":
                        showTime(msg);
                        break;
                    case "star-rating":
                        showStarRating(msg);
                        break;
                    case "video-call":
                        startVideoCall();
                        break;
                    case "disconnect":
                        disconnectVideoCall();
                        break;
                    case "carousel":
                        showCarousel(msg);
                        break;
                    case "free-text":
                        manageTextBox(false);
                        break;
                    case "regex":
                        manageTextBox(false);
                        break;
                    case "stop":
                        stopWorkflow(msg);
                        break;
                    default:
                        manageTextBox(disableTextbox);
                }
            }
        }
        scrollHeight();
    }

    function showOutgoingMessage(msg) {
        switch (msg.data_control) {
            case "button":
            case "multi-button":
            case "multi-select":
            case "single-select":
            case "file-upload":
            case "date":
            case "time":
            case "stop":
                break;
            default:
                $('#lc-chat-window').append(showTextMessage(msg));
        }
    }

    function showButton(msg) {
        $('#lc-chat-window').append('<div class="lc-message ' + ((msg.incoming == true) ? 'lc-message-sent lc-blueclr-msg lc-fade-in' : 'lc-message-received lc-fade-in') + '"> ' + ((msg.incoming == false && avatar) ? '<div class="lc-message-avatar"><img src="' + avatar + '"></div>' : '') + `<div class="lc-message-content"> <div class="lc-message-bubble"> <div class="lc-message-text"> <p>${xssSafeText(msg["liveChatMessageInfo"]["text"])} </p></div></div></div>`);
        $('#lc-data-container').append(`
            <div class="lc-message lc-message-sent lc-blueclr-msg lc-button-list-msg lc-fade-in ">
                <div class="lc-message-content">
                    <div class="lc-message-bubble">
                        <div class="lc-message-text">
                            <ul id="button-list" class="lc-check-outer data-control-${msg.data_control}"></ul>
                        </div>
                    </div>
                </div>
            </div>
        `);

        var heightToSubtract = d.getElementsByClassName('lc-title-pop')[d.getElementsByClassName('lc-title-pop').length - 1].offsetHeight + 115;
        heightToSubtract += d.getElementsByClassName('lc-drag')[d.getElementsByClassName('lc-drag').length - 1].offsetHeight;
        var list = msg.data_source.list;

        // Buttons with labels
        for (var i = 0; i < list.length; i++) {
            $('#button-list').append(`
                <li value="${list[i].value}" data-name="${list[i].dn}" data-uuid="${msg.uuid}">
                    <div class="lc-filtertypecheck">
                        <input class="lc-radiobtn" id="${list[i].value}" type="radio" name="${msg.data_control}">
                        <label for="${list[i].value}">${list[i].dn}</label>
                    </div>
                </li>
            `);
        }

        $('#button-list').css({
            'max-height': `calc(100vh - ${heightToSubtract}px)`
        });

    }

    function showMultiButton(msg) {
        $('#lc-chat-window').append('<div class="lc-message ' + ((msg.incoming == true) ? 'lc-message-sent lc-blueclr-msg lc-fade-in' : 'lc-message-received lc-fade-in') + '"> ' + ((msg.incoming == false && avatar) ? '<div class="lc-message-avatar"><img src="' + avatar + '"></div>' : '') + `<div class="lc-message-content"> <div class="lc-message-bubble"> <div class="lc-message-text"> <p>${xssSafeText(msg["liveChatMessageInfo"]["text"])} </p><div class="lc-buttin-outer-row multi-btn-optns"><div class="lc-button-col"><i> <img src="../images/optionmenu.svg" alt=""> </i> Options </div></div></div></div></div>`);
        var buttonListHtml = '' +
            '<div class="lc-welback-box lc-welfixed-bottom lc-suggest-wrap">' +
            '    <div id="lc-multi-select" style="display:none" class="lc-welinner-box lc-fade-in-up">' +
            '        <div id="content-holder">' +
            '            <div class="lc-drag"><img class="lc-down-icon" src="../images/drag-down.png"><img class="lc-up-icon"' +
            '                    src="../images/drag-up.png" style="display: none;"></div>' +
            '            <div class="lc-title-pop">' +
            '            <div class="lc-content-body multi-btn-ul">' +
            '                <ul id="multi-button-list" class="lc-multi-check-outer"></ul>' +
            '            </div>' +
            '        </div>' +
            '        <div class="lc-pop-bottom"><button type="button" id="lc-multi-send-button" class="lc-btn lc-submit-button lc-fill-btn lc-disable-btn" data-uuid="' + msg.uuid + '">Submit</button>' +
            '        </div>' +
            '    </div>' +
            '</div>';
        $('#lc-data-container').append(buttonListHtml);
        var list = msg.data_source.list;
        for (var i = 0; i < list.length; i++) {
            $('#multi-button-list').append('<li data-uuid="' + msg.uuid + '"> <div class="lc-multicheck"> <input class="lc-radiobtn lc-checkboxbtn" id="' + list[i].value + '" type="checkbox" name="chat-checkbox" value="' + list[i].value + '" data-name="' + list[i].dn + '"><label for="' + list[i].value + '"><span class="lc-cricle-check lc-icon-22"></span> ' + list[i].dn + '</label></div> </li>');
        }
        setMultiSelectContentDivHeight(true);
    }

    function showSingleSelectionList(msg) {
        $('#lc-chat-window').append('<div class="lc-message ' + ((msg.incoming == true) ? 'lc-message-sent lc-blueclr-msg lc-fade-in' : 'lc-message-received lc-fade-in') + '"> ' + ((msg.incoming == false && avatar) ? '<div class="lc-message-avatar"><img src="' + avatar + '"></div>' : '') + `<div class="lc-message-content"> <div class="lc-message-bubble"> <div class="lc-message-text"> <p>${xssSafeText(msg["liveChatMessageInfo"]["text"])} </p><div class="lc-buttin-outer-row single-list-optns"><div class="lc-button-col"><i class="optionMenuIcon"> <img src="../images/optionmenu.svg" alt="" class="optionMenuIcon"> </i> Options </div></div></div></div></div>`);
        $('#lc-data-container').append('<div class="lc-welback-box lc-welfixed-bottom lc-full-card-view lc-choose-options lc-radio-view"><div id="lc-single-select" class="lc-welinner-box lc-fade-in-up"><div class="lc-drag"><img class="lc-down-icon" src="../images/drag-down.png" style=""><img class="lc-up-icon" src="../images/drag-up.png" style="display: none;"></div><div class="lc-search-option"><div class="lc-form-group"> <button class="lc-srch-btn"><i class="lc-icon-35"></i></button><input type="text" placeholder="Search" class="lc-form-control lc-list-search" /></div></div><div class="lc-content-body" style="height:auto"><ul id="single-selection-list" class="lc-multi-check-outer lc-radio-list lc-data-list">  </ul></div> </div></div>');
        var heightToSubtract = d.getElementsByClassName('lc-title-pop')[d.getElementsByClassName('lc-title-pop').length - 1].offsetHeight + 90;
        heightToSubtract += d.getElementsByClassName('lc-drag')[d.getElementsByClassName('lc-drag').length - 1].offsetHeight;
        heightToSubtract += d.getElementsByClassName('lc-search-option')[d.getElementsByClassName('lc-search-option').length - 1].offsetHeight;
        var list = msg.data_source.list;
        for (var i = 0; i < list.length; i++) {
            $('#single-selection-list').append('<li value="' + list[i].value + '" data-name="' + list[i].dn + '" data-uuid="' + msg.uuid + '"> <div class="lc-multicheck lc-singlecheck"><input name="radiobtn" class="lc-radiobtn" id="' + list[i].value + '" type="radio" value="' + list[i].value + '"><label for="' + list[i].value + '"><span class="lc-cricle-check lc-icon-22"></span> ' + list[i].dn + '</label></div> </li>');
        }
        $('#single-selection-list').append('<span class="lc-list-empty lc-hide">No match found.</span>');
        $('#lc-single-select').css({
            'min-height': $('.lc-full-card-view').height() + 'px'
        });
        $('#single-selection-list').css({
            'max-height':'calc( 100vh - '+ heightToSubtract +'px )'
        });
        $('#lc-single-select').hide();
    }

    function showMultiSelectionList(msg) {
        $('#lc-chat-window').append('<div class="lc-message ' + ((msg.incoming == true) ? 'lc-message-sent lc-blueclr-msg lc-fade-in' : 'lc-message-received lc-fade-in') + '"> ' + ((msg.incoming == false && avatar) ? '<div class="lc-message-avatar"><img src="' + avatar + '"></div>' : '') + `<div class="lc-message-content"> <div class="lc-message-bubble"> <div class="lc-message-text"> <p>${xssSafeText(msg["liveChatMessageInfo"]["text"])} </p><div class="lc-buttin-outer-row multi-list-optns"><div class="lc-button-col"><i class="optionMenuIcon"> <img src="../images/optionmenu.svg" alt="" class="optionMenuIcon"> </i> Options </div></div></div></div></div>`);
        var listHtml = '' +
            '<div class="lc-welback-box lc-welfixed-bottom lc-full-card-view lc-choose-options">' +
            '    <div id="lc-multi-select" class="lc-welinner-box lc-fade-in-up">' +
            '        <div id="content-holder">' +
            '            <div class="lc-drag"><img class="lc-down-icon" src="../images/drag-down.png"><img class="lc-up-icon"' +
            '                    src="../images/drag-up.png" style="display: none;"></div>' +
            '            <div class="lc-search-option">' +
            '                <div class="lc-form-group"><button class="lc-srch-btn"><i class="lc-icon-35"></i></button><input type="text"' +
            '                        placeholder="Search" class="lc-form-control lc-list-search" /></div>' +
            '            </div>' +
            '            <div class="lc-content-body">' +
            '                <ul id="multi-selection-list" class="lc-multi-check-outer lc-checkbox-list lc-data-list"> </ul>' +
            '            </div>' +
            '        </div>' +
            '        <div class="lc-pop-bottom data-control-list">' +
            '            <button type="button" class="lc-btn lc-fill-btn lc-submit-button lc-disable-btn" data-uuid="' + msg.uuid + '">Submit</button>' +
            '        </div>' +
            '    </div>' +
            '</div>';
        $('#lc-data-container').append(listHtml);

        var list = msg.data_source.list;
        for (var i = 0; i < list.length; i++) {
            $('#multi-selection-list').append('<li data-uuid="' + msg.uuid + '"> <div class="lc-multicheck"><input class="lc-radiobtn" id="' + list[i].value + '" type="checkbox" name="chat-checkbox" value="' + list[i].value + '"  data-name="' + list[i].dn + '"><label for="' + list[i].value + '"><span class="lc-cricle-check lc-icon-22"></span> ' + list[i].dn + ' </label></div></li>');
        }
        $('#multi-selection-list').append('<span class="lc-list-empty lc-hide">No match found.</span>');
        $('#lc-multi-select').css({
            'min-height': $('.lc-full-card-view').height() + 'px'
        });
        setMultiSelectContentDivHeight(true);
    }

    function setMultiSelectContentDivHeight(includeMargin) {
        var chatPageHt = $("#lc-messages-chat-page").outerHeight(includeMargin);
        var chatPageHeaderHt = $(".lc-header-wrap").outerHeight(includeMargin);

        var downArrowHt = $("#lc-multi-select .lc-drag").outerHeight(includeMargin);
   //     var titleHt = $("#lc-multi-select .lc-title-pop").outerHeight(includeMargin);
        var submitHt = $("#lc-multi-select .lc-pop-bottom").outerHeight(includeMargin);

        var searchBxHt = 0;
        var searchTxtBx = $("#lc-multi-select .lc-search-option");
        if ($(searchTxtBx) && $(searchTxtBx).length) {
            searchBxHt = $(searchTxtBx).outerHeight(includeMargin);
        }
        var calHeight = (chatPageHt - chatPageHeaderHt) - (downArrowHt + submitHt + searchBxHt + 40);

        var multiSelectContent = $("#lc-multi-select .lc-content-body");
        var ulHeight = $(multiSelectContent).find("ul").outerHeight(includeMargin);
        if (calHeight > ulHeight) {
            calHeight = ulHeight;
        }
        $(multiSelectContent).css('height', calHeight);
        $('#lc-multi-select').hide();
    }

    $(window).on('resize', function(){
        setMultiSelectContentDivHeight(true);
    });

    function showFileUpload(msg) {
    let isTitleTextShared = false;
    let fileHtml = `
    <div class="lc-message ${msg.incoming === true ? 'lc-message-sent lc-blueclr-msg lc-fade-in' : 'lc-message-received lc-fade-in'}">
    ${msg.incoming === false && avatar ? '<div class="lc-message-avatar"><img src="' + avatar + '"></div>' : ''}
    <div class="lc-message-content">
      <form id="fileupload" action="#" method="POST" enctype="multipart/form-data">
        <div class="files upload-files" id="upload-files" data-uuid="${msg.uuid}">
          <div id="lc-file-dashboard">
            <div class="lc-message-bubble">
              <div class="lc-message-text">
                <p>${xssSafeText(msg.liveChatMessageInfo.text)}</p>
                <div class="lc-content-body fileUploadBtn">
                  <div class="lc-btn lc-button-col lc-upload-btn">
                    <input type="file" />
                    <i> <img src="../images/pinattach.svg" alt=""> </i>Choose from Device
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
    </div>`;
    let fileList = `<div id="lc-file-list" style="display:none;" class="lc-welback-box lc-welfixed-bottom lc-dup-popup files upload-files" data-uuid="${msg.uuid}">
            <div class="lc-content-body lc-welinner-box lc-fade-in-up">
            <div class="lc-drag"><img class="lc-down-icon" src="../images/drag-down.png" style=""><img class="lc-up-icon" src="../images/drag-up.png" style="display: none;"></div>
              <ul class="lc-upload-process-list upload-file-list"> </ul>
              <div class="lc-pop-bottom">
                <div class="lc-btn lc-border-btn">
                  <i class="lc-icon-40"></i> Add<input type="file" />
                </div>
                <button type="button" class="lc-btn lc-border-btn file-upload-btn">Send</button>
              </div>
            </div>
          </div>`;

         var fileToUpload = {};
        $('#lc-data-container').append(fileHtml).append(fileList);
        $.fn.fileUploader = function(fileToUpload, fileId) {
            this.closest(".files").change(function(evt) {
                if(!isTitleTextShared) {
                    $('#lc-chat-window').append('<div class="lc-message ' + ((msg.incoming == true) ? 'lc-message-sent lc-blueclr-msg lc-fade-in' : 'lc-message-received lc-fade-in') + '"> ' + ((msg.incoming == false && avatar) ? '<div class="lc-message-avatar"><img src="' + avatar + '"></div>' : '') + `<div class="lc-message-content"> <div class="lc-message-bubble"> <div class="lc-message-text"> <p>${xssSafeText(msg["liveChatMessageInfo"]["text"])} </p></div></div></div>`);
                }
                $(".upload-file-list").empty();
                var file = evt.target.files[0];
                fileToUpload.id = fileId;
                fileToUpload.file = file;
                var thumbnail = getThumbnail(file.type);
                $("#lc-file-dashboard").hide();
                $("#lc-file-list").fadeIn();
                var reader = new FileReader();
                reader.onload = function(e) {
                    $(".upload-file-list").append('<li>' +
                        ' <div class="lc-up-box">' +
                        '        <div class="lc-pic-area"><img src="'+(thumbnail == 'image' ? e.target.result :'/images/'+thumbnail+'.png') + '" alt="img"/></div>' +
                        '        <p>' + escape(file.name) + '</p> <a class="lc-delete-btn file-upload-remove-btn" data-fileid="' + fileId + '"><i class="lc-icon-42"></i></a>' +
                        '        <div class="lc-upload-progress-wrap">' +
                        '           <span class="lc-progress-bar lc-bar-color" style="width: 0%; background-color: #007fff;"></span>' +
                        '        </div>' +
                        '    </div>' +
                        ' </li>');
                        isTitleTextShared = true;
                };
                reader.readAsDataURL(file);

                // reset the input to null - nice little chrome bug!
                evt.target.value = null;
            });

            $(this).on("click", ".file-upload-remove-btn", function(e) {
                e.preventDefault();
                fileToUpload = {};
                $(this).parent().remove();
            });

            this.clear = function() {
                fileToUpload = {};
                $(".upload-file-list").empty();
            }

            $(".file-upload-btn").click(function(e) {
                e.preventDefault();
                if (jQuery.isEmptyObject(fileToUpload)) {
                    $(".upload-file-list").empty();
                    $(".upload-file-list").append('<li class="lc-file-upload-error"> Please select a file!</li>');
                    return;
                }
                var size = fileToUpload.file.size;
                if(size > 104857600) {
                    $(".upload-file-list").empty();
                    $(".upload-file-list").append('<li class="lc-file-upload-error">File size is too big: Max limit is 100 MB</li>');
                    return;
                }
                var ext = fileToUpload.file.name.split('.').pop().toLowerCase();
                if ($.inArray(ext, ['gif', 'png', 'jpg', 'jpeg', 'pdf', 'xls', 'xlsx', 'doc', 'docx', 'ppt', 'pptx', 'txt', 'csv', 'mp4', 'avi', 'flv', 'mkv']) == -1) {
                    $(".upload-file-list").empty();
                    $(".upload-file-list").append('<li class="lc-file-upload-error"> Error: File type is not supported</li>');
                    fileToUpload = {};
                    return;
                }
                var formData = new FormData();
                formData.append("file", fileToUpload.file);

                $.ajax({
                    xhr: function() {
                        var xhr = new window.XMLHttpRequest();
                        xhr.upload.addEventListener("progress", function(evt) {
                            if (evt.lengthComputable) {
                                var percentComplete = ((evt.loaded / evt.total) * 100);
                                setProgressBar(percentComplete - 10);
                            }
                        }, false);
                        return xhr;
                    },
                    type: 'POST',
                    url: w.location.protocol + '//' + botifyHostName + '/api/v1/livechat/file-upload/' + appId + '/' + userId,
                    data: formData,
                    contentType: false,
                    cache: false,
                    processData: false,
                    beforeSend: function() {
                        setProgressBar(0);
                    },
                    error: function(data) {
                        $(".upload-file-list").empty();
                        $(".upload-file-list").append('<li class="lc-file-upload-error"> <div class="lc-up-box lc-retry-box"> <div class="lc-pic-area"></div> <p>' + data.statusText + '</p> <a class="lc-retry-bt file-upload-btn">Retry</a> <div class="lc-upload-progress-wrap"><span class="lc-bar-color" style="width: 0%;"></span></div></div></li>');
                    },
                    success: function(data) {
                        if (data.result != null && data.status == 200) {
                            var uuid = $('.upload-files').attr("data-uuid");
                            sendMessage(createJSON(messages[uuid].data_control, fileToUpload.file.name, data.result), 'TEXT', 'SEND_MESSAGE', false);
                            fileToUpload = {};
                            resetDataControl(uuid);
                        } else {
                            $(".upload-file-list").append('<li class="lc-file-upload-error">Please select a valid file to upload.</li>');
                        }
                        setProgressBar(100);
                        repeatedMessage = false;
                    }
                });
            });
            return this;
        };

        function getThumbnail(type) {
            var fileExt = "file";
            if (type == "application/doc" || type == "application/ms-doc" || type == "application/msword" || type == "application/vnd.openxmlformats-officedocument.wordprocessingml.document" || type == "application/wps-office.docx") {
                fileExt = "doc";
            } else if (type == "application/pdf") {
                fileExt = "pdf";
            } else if (type == "application/excel" || type == "application/vnd.ms-excel" || type == "application/x-excel" || type == "application/x-msexcel" || type == "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" || type == "application/wps-office.xlsx") {
                fileExt = "exel";
            } else if(type.includes('image/')) {
                fileExt = "image";
            }
            return fileExt;
        }

        function setProgressBar(percentage) {
            $('.lc-progress-bar').css({'width': percentage + '%', 'background-color' : (percentage > 60) ? '#007fff;' : '#34c86b;'});
        }

        (function() {
            var filesUploader = $(".upload-files").fileUploader(fileToUpload, "upload-file");
        })()
    }

    function showFullName(msg) {
        $('.lc-text-message').attr("placeholder", "Ex: Adam Williams");
        $('.lc-text-message').attr("data-uuid", msg.uuid);
        manageTextBox(false);
        focusTextMessage();
    }

    function showAddress(msg) {
        $('#lc-text-box').show();
        $('#lc-tel-box').hide();
        $('.lc-text-message').attr("placeholder", "Ex: B-14, JTM, Jaipur");
        $('.lc-text-message').attr("data-uuid", msg.uuid);
        $('.lc-text-message-outer').addClass("lc-address-bar");
        manageTextBox(false);
        focusTextMessage();
    }

    function showPassword(msg) {
        $('.lc-text-message').attr("placeholder", "Please enter password");
        $('.lc-text-message').attr("data-uuid", msg.uuid);
        $('.lc-text-message').addClass("lcNoSpace");
        $('.lc-text-message').addClass("lc-password");
        manageTextBox(false);
        focusTextMessage();
    }

    function showEmail(msg) {
        $('.lc-text-message').attr("placeholder", "Ex: adam@gmail.com");
        $('.lc-text-message').attr("data-uuid", msg.uuid);
        $('.lc-text-message').addClass("lcNoSpace");
        manageTextBox(false);
        focusTextMessage();
    }

    function showMobileNumber(msg) {
        $('#lc-tel-box').attr("type", "tel");
        $('.lc-text-message').attr("placeholder", "Ex: 8430806595");
        $('.lc-text-message').attr("data-uuid", msg.uuid);
        $('.lc-text-message').addClass("lcDigitsOnly");
        manageTextBox(false);
        focusTextMessage();
    }

    function showNumber(msg) {
        $('#lc-tel-box').attr("type", "tel");
        $('.lc-text-message').attr("placeholder", "Please enter number");
        $('.lc-text-message').attr("data-uuid", msg.uuid);
        $('.lc-text-message').addClass("lcDigitsOnly");
        manageTextBox(false);
        focusTextMessage();
    }

    function showDate(msg) {
        $('#lc-data-container').append('<div class="lc-welback-box lc-welfixed-bottom lc-calander-wrap lc-calendar"> <div class="lc-welinner-box lc-fade-in-up"><div class="lc-drag"><img class="lc-down-icon" src="../images/drag-down.png"><img class="lc-up-icon" src="../images/drag-up.png" style="display: none;"></div><div class="lc-title-pop"><div class="lc-inner-title">' + ((msg.liveChatMessageInfo.text == undefined) ? '' : xssSafeText(msg.liveChatMessageInfo.text)) + '</div></div><div class="lc-content-body"> <div class="lc-calender-block"> <div data-toggle="datepicker" id="lc-calendar" data-uuid="' + msg.uuid + '"></div> </div></div></div></div>');
        $('#lc-data-container').append(' <div class="lc-welback-box lc-welfixed-bottom lc-choose-appointment lc-choose-appointment-date" style="display:none;"><div class="lc-welinner-box lc-fade-in-up"><div class="lc-drag"><img class="lc-down-icon" src="../images/drag-down.png"><img class="lc-up-icon" src="../images/drag-up.png" style="display: none;"></div><div class="lc-title-pop"><div class="lc-inner-title">' + ((msg.liveChatMessageInfo.text == undefined) ? '' : xssSafeText(msg.liveChatMessageInfo.text)) + '</div></div><div class="lc-content-body"><ul class="lc-time-date-outer"><li><a class="lc-tt-check lc-booking-appointment-date lc-change-my-date"><label>4-April-2019</label><span class="lc-cricle-check lc-icon-22"></span></a></li></ul><div class="lc-pop-bottom"><button type="button" class="lc-btn lc-fill-btn lc-submit-button" data-uuid="' + msg.uuid + '">Submit</button></div></div></div></div>');
        $('[data-toggle="datepicker"]').datepicker({
            container: "div#lc-calendar",
            autoShow: true,
            inline: true,
            pick: function(e) {
                e.preventDefault();
                if (e.view == 'day') {
                    var month = $(this).datepicker('getMonthName');
                    lcAppointmentDate = e.date.getDate() + "-" + month + "-" + e.date.getFullYear();
                    $('.lc-booking-appointment-date > label').text(lcAppointmentDate);
                    $('.lc-calendar').hide();
                    $('.lc-choose-appointment-date').fadeIn();
                }
            }
        });
    }

    function showTime(msg) {
        $('#lc-data-container').append('<div class="lc-welback-box lc-welfixed-bottom lc-time-slot-popup lc-pre-cts" data-uuid="' + msg.uuid + '"> <div class="lc-welinner-box lc-fade-in-up"><div class="lc-drag"><img class="lc-down-icon" src="../images/drag-down.png"><img class="lc-up-icon" src="../images/drag-up.png" style="display: none;"></div><div class="lc-title-pop"> <div class="lc-inner-title">Indicate a suitable time</div></div><div class="lc-content-body"> <div class="lc-time-slote-wrap"><ul id="lc-timepicker-list">  </ul> </div><div class="lc-pop-bottom lc-pre-cts"> <button type="button" class="lc-btn lc-border-btn lc-choose-my-time">Customize Time</button> </div></div></div> </div>');
        $('#lc-timepicker-list').append('<li> <div class="lc-time">12:00 AM</div> </li><li> <div class="lc-time">12:30 AM</div> </li><li> <div class="lc-time">01:00 AM</div> </li><li> <div class="lc-time">01:30 AM</div> </li><li> <div class="lc-time">02:00 AM</div> </li><li> <div class="lc-time">02:30 AM</div> </li><li> <div class="lc-time">03:00 AM</div> </li><li> <div class="lc-time">03:30 AM</div> </li><li> <div class="lc-time">04:00 AM</div> </li><li> <div class="lc-time">04:30 AM</div> </li><li> <div class="lc-time">05:00 AM</div> </li><li> <div class="lc-time">05:30 AM</div> </li><li> <div class="lc-time">06:00 AM</div> </li><li> <div class="lc-time">06:30 AM</div> </li><li> <div class="lc-time">07:00 AM</div> </li><li> <div class="lc-time">07:30 AM</div> </li><li> <div class="lc-time">08:00 AM</div> </li><li> <div class="lc-time">08:30 AM</div> </li><li> <div class="lc-time">09:00 AM</div> </li><li> <div class="lc-time">09:30 AM</div> </li><li> <div class="lc-time">10:00 AM</div> </li><li> <div class="lc-time">10:30 AM</div> </li><li> <div class="lc-time">11:00 AM</div> </li><li> <div class="lc-time">11:30 AM</div> </li><li> <div class="lc-time">12:00 PM</div> </li><li> <div class="lc-time">12:30 PM</div> </li><li> <div class="lc-time">01:00 PM</div> </li><li> <div class="lc-time">01:30 PM</div> </li><li> <div class="lc-time">02:00 PM</div> </li><li> <div class="lc-time">02:30 PM</div> </li><li> <div class="lc-time">03:00 PM</div> </li><li> <div class="lc-time">03:30 PM</div> </li><li> <div class="lc-time">04:00 PM</div> </li><li> <div class="lc-time">04:30 PM</div> </li><li> <div class="lc-time">05:00 PM</div> </li><li> <div class="lc-time">05:30 PM</div> </li><li> <div class="lc-time">06:00 PM</div> </li><li> <div class="lc-time">06:30 PM</div> </li><li> <div class="lc-time">07:00 PM</div> </li><li> <div class="lc-time">07:30 PM</div> </li><li> <div class="lc-time">08:00 PM</div> </li><li> <div class="lc-time">08:30 PM</div> </li><li> <div class="lc-time">09:00 PM</div> </li><li> <div class="lc-time">09:30 PM</div> </li><li> <div class="lc-time">10:00 PM</div> </li><li> <div class="lc-time">10:30 PM</div> </li><li> <div class="lc-time">11:00 PM</div> </li><li> <div class="lc-time">11:30 PM</div> </li>');
        $('#lc-data-container').append('<div class="lc-welback-box lc-welfixed-bottom lc-cts lc-choose-cts" style="display:none;"><div class="lc-welinner-box lc-fade-in-up"><div class="lc-drag"><img class="lc-down-icon" src="../images/drag-down.png"><img class="lc-up-icon" src="../images/drag-up.png" style="display: none;"></div><div class="lc-title-pop"><div class="lc-inner-title">Indicate a suitable time</div></div><div class="lc-content-body"><div class="lc-input-row"><div class="lc-input-cell"><div class="lc-input-group lc-active-label lc-time-picker"><label class="lc-label-text">My time (12 hrs. format)</label> <select id="lc-time-hour" class="lc-time-select lc-time-hour"></select> <span class="lc-time-colon">:&nbsp;</span><select id="lc-time-minute" class="lc-time-select lc-time-minute"></select> <span class="lc-time-period">PM</span> </div></div><div class="lc-switch-outer"><label class="lc-switch-btn lc-ap-pm-switch"><input type="checkbox" name="lc-ap-pm-switch" checked="checked"><div class="lc-slider-btn round"></div><span class="texts"></span></label></div></div><div class="lc-pop-bottom"><button type="button" class="lc-btn lc-fill-btn lc-submit-button" data-uuid="' + msg.uuid + '">Submit</button></div></div></div></div>');
        $('#lc-data-container').append(' <div class="lc-welback-box lc-welfixed-bottom lc-choose-appointment lc-choose-appointment-time" style="display:none;"><div class="lc-welinner-box lc-fade-in-up"><div class="lc-drag"><img class="lc-down-icon" src="../images/drag-down.png"><img class="lc-up-icon" src="../images/drag-up.png" style="display: none;"></div><div class="lc-title-pop"><div class="lc-inner-title">' + ((msg.liveChatMessageInfo.text == undefined) ? '' : xssSafeText(msg.liveChatMessageInfo.text)) + '</div></div><div class="lc-content-body"><ul class="lc-time-date-outer"><li><a class="lc-tt-check lc-booking-appointment-time lc-change-my-time"><label class="lc-cp">10:00 AM</label><span class="lc-cricle-check lc-icon-22"></span></a></li></ul><div class="lc-pop-bottom"><button type="button" class="lc-btn lc-fill-btn lc-submit-button" data-uuid="' + msg.uuid + '">Submit</button></div></div></div></div>');
        for (var i = 1; i <= 12; i++) {
            $('#lc-time-hour').append('<option value="' + getDateTime(i) + '">' + getDateTime(i) + '</option>');
        }
        for (var i = 0; i < 59; i+=5) {
            $('#lc-time-minute').append('<option value="' + getDateTime(i) + '">' + getDateTime(i) + '</option>');
        }
    }

    function getDateTime(n) {
        return (n <= 9 ? "0" : "") + (n);
    }
 // Time selection
    $(d).on("click", "#lc-timepicker-list > li", function() {
        $("li").not(this).removeClass("lc-active");
        $(this).addClass("lc-active");
        $('.lc-pre-cts').hide();
        $('.lc-choose-appointment-time').fadeIn();
        lcAppointmentTime = $(this).text();
        $('.lc-booking-appointment-time > label').text(lcAppointmentTime);
    });

    $(d).on("click", ".lc-choose-my-time", function() {
        $('.lc-pre-cts').hide();
        $('.lc-choose-cts').fadeIn();
    });

    $(d).on("click", ".lc-change-my-time", function() {
        $('.lc-choose-cts').hide();
        $('.lc-choose-appointment-time').hide();
        $('.lc-pre-cts').fadeIn();
    });

    $(d).on("click", ".lc-ap-pm-switch", function() {
        if ($("input[name=lc-ap-pm-switch]:checked").length > 0) {
            $('.lc-time-period').text('PM');
        } else {
            $('.lc-time-period').text('AM');
        }
        setTime();
    });

    $(d).on("click", ".lc-change-my-date", function() {
        $('.lc-choose-appointment-date').hide();
        $('.lc-calendar').fadeIn();
    });

    $(d).on("change", ".lc-time-select", function() {
        setTime();
    });

    function setTime() {
        var hour = $("#lc-time-hour").children("option:selected").val();
        var minute = $("#lc-time-minute").children("option:selected").val();
        var period = $('.lc-time-period').text();
        lcAppointmentTime = hour + ':' + minute + ' ' + period;
    }

    function showStarRating(msg) {
        $('#lc-data-container').append(' <div class="lc-welback-box lc-welfixed-bottom lc-calander-wrap"><div class="lc-welinner-box lc-fade-in-up"><div class="lc-drag"><img class="lc-down-icon" src="../images/drag-down.png"><img class="lc-up-icon" src="../images/drag-up.png" style="display: none;"></div><div class="lc-title-pop"><div class="lc-inner-title">Rate your experience with me </div></div><div class="lc-content-body"><ul id="lc-star-rating-list" class="lc-star-ratint-wrap"> </ul></div></div></div>');
        for (var i = 1; i <= 4; i++) {
            $('#lc-star-rating-list').append('<li class="lc-star lc-active" data-value="' + i + '" data-uuid="' + msg.uuid + '"> <i class="lc-icon-19"></i></li>');
        }
    }

    function showCarousel(msg) {
        $('#lc-chat-window').append('<div class="lc-carousel-container"><div class="lc-message lc-message-received lc-msg-slide-outer"><div class="message-content"><div class="message-bubble lc-articles-slider"><ul class="carousel-list lc-article-inner-slide lc-sld-art-box data-control-' + msg.data_control + '"></ul></div></div></div></div>');
        var list = msg.data_source.list;
        for (var i = 0; i < list.length; i++) {
            var ctaType = list[i].cta_type;
            var ctaButton = "";
            if (ctaType == "Redirect") {
                ctaButton = '<a href="javascript:void(0);" class="cta-btn cta-btn-redirect" value="' + list[i].value + '" data-name="' + list[i].title + '" data-uuid="' + msg.uuid + '" data-url="' + list[i].url + '" data-description="' + list[i].description + '" data-cta-type="' + list[i].cta_type + '" data-cta-value="' + list[i].cta_value + '"><i class="lc-carousel-radio"><img src="/images/new-window.svg" alt="icon"/></i><span class="lc-ellipsis">' + ((list[i].cta == undefined) ? 'Click Here' : list[i].cta) + '</span></a>';
            } else if (ctaType == "Call On Phone") {
                ctaButton = '<a href="javascript:void(0);" class="cta-btn cta-btn-call" value="' + list[i].value + '" data-name="' + list[i].title + '" data-uuid="' + msg.uuid + '" data-url="' + list[i].url + '" data-description="' + list[i].description + '" data-cta-type="' + list[i].cta_type + '" data-cta-value="' + list[i].cta_value + '"><i class="lc-carousel-radio"><img src="/images/call_3.svg" alt="icon"/></i><span class="lc-ellipsis">' + ((list[i].cta == undefined) ? 'Click Here' : list[i].cta) + '</span></a>';
            }
            var defaultCtaButton = '<a href="javascript:void(0);" class="cta-btn cta-btn-select" value="' + list[i].value + '" data-name="' + list[i].title + '" data-uuid="' + msg.uuid + '" data-url="' + list[i].url + '" data-description="' + list[i].description + '" data-cta-type=Default data-cta-value="' + list[i].cta_value + '">'
            var isSingleButton = true;
            if (ctaButton != "") {
                isSingleButton = false;
                // In case of single default cta, radio button is not required.
                // Need radio button icon only if there's another cta along with default.
                defaultCtaButton += '<i class="lc-carousel-radio"><img class="lc-unchecked" src="/images/radio-btn.svg" alt="icon"/><img class="lc-checked" src="/images/radio-btn-checked.svg" alt="icon"/></i>';
            }
            defaultCtaButton += '<span class="lc-ellipsis">Select</span></a>';

            $('.carousel-list:last').append('<li class="carousel-list-item' + ((isSingleButton) ? ' single-btn' : '') + '"> <div class="lc-slide-box"><div class="lc-article-img"> <img src="' + list[i].url + '" alt="image"></div><div class="lc-article-body"><h2>' + list[i].title + '</h2><div class="lc-article-description">' + list[i].description + '</div>'
                + '<div class="lc-carousel-btns-row">'
                    + defaultCtaButton
                    + ctaButton
                + '</div>'
                + '</div></div></li>');
        }
        addSlickToCarousel();
    }

    function addSlickToCarousel() {
        if (isMobile()) {
            return;
        } else {
            $('.carousel-list:last').addClass('lc-slider-wrap');
        }
        // Show left/right arrows
        $('.lc-slider-wrap:last').slick({dots: false,infinite: false,speed: 300,slidesToShow: 1.5,slidesToScroll: 1,arrows: true});
    }

    function stopWorkflow(msg) {
        $('.lc-text-message').attr("placeholder", "Please start a new conversation");
        $('.lc-text-message').attr("data-uuid", msg.uuid);
        manageTextBox(true);
    }

    function showTextMessage(msg) {
        if (msg.liveChatMessageInfo.type == 'TEXT' && $.isEmptyObject(msg.liveChatMessageInfo.text)) {
            return;
        }
        return '<div class="lc-message ' + ((msg.incoming == true) ? 'lc-message-sent lc-blueclr-msg lc-fade-in' : 'lc-message-received lc-fade-in') + '"> ' + ((msg.incoming == false && avatar) ? '<div class="lc-message-avatar"><img src="' + avatar + '"></div>' : '') + '<div class="lc-message-content">' + parseIncomeingMessage(msg) + '<div class="lc-message-footer">3minutes ago</div></div></div>';
    }

    function parseIncomeingMessage(livechatMsg) {
        var text = "";
        var message = livechatMsg.liveChatMessageInfo;
        if (message.type == 'TEXT') {
            if (isJSONValid(message.text)) {
                text = getMessageText(JSON.parse(message.text));
            } else {
                if (livechatMsg.incoming == true) {
                    var innerText = checkAndAppendUrl(message.text);
                    text = '<div class="lc-message-bubble"><div class="lc-message-text"><p>' + xssSafeText(innerText) + '</p></div></div>';
                } else {
                    text = '<div class="lc-message-bubble"><div class="lc-message-text"><p>' + xssSafeText(message.text) + '</p></div></div>';
                }
            }
        } else if (message.type == 'IMAGE') {
            text = '<div class="lc-message-bubble lc-message-image"> <img src="' + message.imageUrl + '"> ' + ((message.caption == '') ? '' : '<div class="lc-file-name">' + message.caption + '</div>') + ' </div>';
        } else if (message.type == 'VIDEO') {
            text = '<div class="lc-message-bubble lc-message-image"> <video controls> <source src="' + message.imageUrl + '"> </video> ' + ((message.caption == '') ? '' : '<div class="lc-file-name">' + message.caption + '</div>') + ' </div>';
        } else if (message.type == 'VOICE') {
            text = '<div class="lc-message-bubble lc-aud-bubble"> <audio controls> <source src="' + message.imageUrl + '"> </audio> ' + ((message.caption == '') ? '' : '<div class="lc-file-name">' + message.caption + '</div>') + ' </div>';
        } else if (message.type == 'DOCUMENT') {
            var iconClass = 'lc-icon-50';
            if(message.imageUrl != '') {
                if(message.imageUrl.endsWith('.pdf')) {
                    iconClass = 'lc-icon-13';
                } else if(message.imageUrl.endsWith('.zip') || message.imageUrl.endsWith('.rar')) {
                    iconClass = 'lc-icon-49';
                } else if(message.imageUrl.endsWith('.doc') || message.imageUrl.endsWith('.docx')) {
                    iconClass = 'lc-icon-47';
                } else if(message.imageUrl.endsWith('.xls') || message.imageUrl.endsWith('.xlsx')) {
                    iconClass = 'lc-icon-48';
                }
            }
            text = '<div class="lc-message-bubble"> <div class="lc-message-text lc-doc-attach"> <i class="' + iconClass + '"></i> <a href="'+ message.imageUrl + '" target="_blank">' + ((message.caption == '') ? 'Click Here' : message.caption ) + '</a> </div> </div>';
        }
        return text;
    }

    function xssSafeText(str) {
        return str.replace(/<script/g,'&lt;script').replace(/<\/script>/g,'&lt;/script&gt;');
    }

    function checkAndAppendUrl(messageText) {
        var msgArray = messageText.split(" ");
        var msg = "";
        for (var i = 0; i < msgArray.length; i++) {
            var text = msgArray[i];
            if(text.startsWith("http") || text.startsWith("https") || text.startsWith("ftp") || text.startsWith("sftp")) {
                msg = msg.concat("<a href='",text,"' target='_blank'>",text,"</a> ");
            }else {
                msg = msg.concat(text," ");
            }
        }
        return msg;
    }

    function isJSONValid(messageText) {
        try {
            var o = JSON.parse(messageText);

            // Handle non-exception-throwing cases:
            // Neither JSON.parse(false) or JSON.parse(1234) throw errors, hence the type-checking,
            // but... JSON.parse(null) returns null, and typeof null === "object", 
            // so we must check for that, too. Thankfully, null is falsey, so this suffices:
            if (o && typeof o === "object") {
                return true;
            }
        } catch (e) {}
        return false;
    }

    function getMessageText(messageText) {
        var text = "";
        switch (messageText.control_name) {
            case "multi-button":
            case "multi-select":
                var textInner = "";
                for (var i = 0; i < messageText.selected_values.length; i++) {
                    textInner += messageText.selected_values[i].dn + '\n';
                }
                text += '<div class="lc-message-bubble"><div class="lc-message-text"><p>' + textInner + '</p></div></div>';
                break;
            case "file-upload":
                for (var i = 0; i < messageText.selected_values.length; i++) {
                    if (isImageOnMessage(messageText.selected_values[i].dn)) {
                        text += '<div class="lc-message-bubble lc-message-image"><img src="' + messageText.selected_values[i].value + '"> <div class="lc-file-name">' + messageText.selected_values[i].dn + '</div></div>';
                    } else {
                        text += '<div class="lc-message-bubble"><div class="lc-message-text"><p>' + messageText.selected_values[i].dn + '</p></div></div>';
                    }
                }
                break;
            case "carousel":
                text += '<div class="lc-message-bubble"><div class="lc-message-text"><p>' + messageText.selected_values[0].title + '</p></div></div>';
                break;
            default:
                text += '<div class="lc-message-bubble"><div class="lc-message-text"><p>' + xssSafeText(messageText.selected_values[0].dn) + '</p></div></div>';
        }
        return text;
    }

    function isImageOnMessage(messageText) {
        var ext = messageText.split('.').pop().toLowerCase();
        if ($.inArray(ext, ['gif', 'png', 'jpg', 'jpeg']) == -1) {
            return false;
        }
        return true;
    }

    function manageTextBox(action) {
        $('.lc-text-message').prop('disabled', action);
    }

    function isEmpty(el) {
        return !$.trim(el.html());
    }

    /**** Star Rating ***/
    $(d).on("mouseover", ".lc-star-ratint-wrap li", function() {
        var onStar = parseInt($(this).data('value'), 10);
        $(this).parent().children('li.lc-star').each(function(e) {
            if (e < onStar) {
                $(this).addClass('lc-hover');
            } else {
                $(this).removeClass('lc-hover');
            }
        });
    }).on('mouseout', function() {
        $(this).parent().children('li.lc-star').each(function(e) {
            $(this).removeClass('lc-hover');
        });
    });

    $(d).on("click", ".lc-star-ratint-wrap li", function() {
        var onStar = parseInt($(this).data('value'), 10);
        var stars = $(this).parent().children('li.lc-star');
        var uuid = $(this).attr("data-uuid");
        for (var i = 0; i < stars.length; i++) {
            $(stars[i]).removeClass('lc-active');
        }
        for (var i = 0; i < onStar; i++) {
            $(stars[i]).addClass('lc-active');
        }
        var displayName = onStar + " Star rate";
        sendMessage(createJSON(messages[uuid].data_control, displayName, onStar.toString()), 'TEXT', 'SEND_MESSAGE', false);
        resetDataControl(uuid);
    });

    $(d).on("keypress", ".lcDigitsOnly", function(e) {
        if (e.which != 8 && e.which != 0 && (e.which < 48 || e.which > 57)) {
            return false;
        }
    });

    $(d).on("cut copy paste", ".lcDigitsOnly", function(e) {
        if (e.originalEvent.clipboardData.getData('Text').match(/[^\d]/)) {
            e.preventDefault();
        }
    });

    // Select and reply for single select
    $(d).on("click", "#single-selection-list > li", function() {
        var value = $(this).attr("value");
        var displayName = $(this).attr("data-name");
        var uuid = $(this).attr("data-uuid");
        sendMessage(createJSON(messages[uuid].data_control, displayName, value), 'TEXT', 'SEND_MESSAGE', false);
        resetDataControl(uuid);
    });

 // Multi selection
    $(d).on("click", "#multi-selection-list > li", function() {
        if ($("input[name=chat-checkbox]:checked").length > 0) {
            $(".lc-submit-button").removeClass("lc-disable-btn");
        } else {
            $(".lc-submit-button").addClass("lc-disable-btn");
        }
    });

    // Restrict space
    $(d).on('keydown', '.lcNoSpace', function(e) {
        if (e.keyCode == 32) return false;
    });

    // Text box keyup
    $(d).on("keyup", ".lc-text-message", function() {
        var value = $(this).val();
        if (value.trim() == '' || value == undefined) {
            $(".lc-send-button").removeClass("lc-active-send-btn");
        } else {
            $(".lc-send-button").addClass("lc-active-send-btn");
        }
    });

    // Load history
    $(d).on("click", "#load-history", function() {
        $('.lc-load-history').remove();
        $('#lc-chat-window').removeClass("hidden");
        scrollHeight();
    });

    // Single Chat Button on select and send from here..
    $(d).on("click", ".data-control-button > li", function() {
        var value = $(this).attr('value');
        var displayName = $(this).attr("data-name");
        var uuid = $(this).attr("data-uuid");
        if (value != undefined) {
            if (isResetState) {
                sendMessage(value, 'TEXT', 'SEND_MESSAGE', true);
            } else {
                sendMessage(createJSON(messages[uuid].data_control, displayName, value), 'TEXT', 'SEND_MESSAGE', false);
            }
            resetDataControl(uuid);
        }
    });
    
    // Single Chat Button on select and send from here..
    $(d).on("click", ".data-control-carousel li.carousel-list-item .cta-btn, .data-control-carousel li.carousel-list-item.single-btn", function(e) {
        // In case of only single default CTA, whole card is clickable. So, item can be selected either by clicking on default(Select)
        // CTA button, or by clicking anywhere on card. In such case if button is clicked, click event handler on card(li)
        // shouldn't be called.
        var isButtonClicked = false;
        if ($(this).hasClass("cta-btn")) {
            isButtonClicked = true;
            e.stopPropagation();
        }
        var ul = $(this).closest(".carousel-list");
        var listItem;
        var ctaButton;
        if (isButtonClicked) {
            ctaButton = $(this);
            listItem = $(this).closest("li.carousel-list-item");
        } else {
            // Card(li) is clicked.
            listItem = $(this);
            ctaButton = $(this).find(".cta-btn");
        }

        var value = $(ctaButton).attr('value');
        var title = $(ctaButton).attr("data-name");
        var url = $(ctaButton).attr("data-url");
        var description = $(ctaButton).attr("data-description");
        var uuid = $(ctaButton).attr("data-uuid");
        var ctaType = $(ctaButton).attr("data-cta-type");
        var ctaValue = $(ctaButton).attr("data-cta-value");
        if(ctaType == "Redirect") {
            window.open(ctaValue,'_blank');
        } else if (ctaType == "Call On Phone") {
            window.location.href = 'tel:'+ctaValue;
        } else if (ctaType == "Default") {
            listItem.addClass("lc-selected");
            $(ul).find(".carousel-list-item").addClass("lc-disabled");
            if (value != undefined) {
                if (isResetState) {
                    sendMessage(value, 'TEXT', 'SEND_MESSAGE', true);
                } else {
                    sendMessage(createJSONForCarousel("carousel", title, value, url, description), 'TEXT', 'SEND_MESSAGE', false);
                }
                resetDataControl(uuid);
            }
        }
    });
    
    function createJSONForCarousel(controlName, title, value, url, description) {
        if ($.isEmptyObject(value)) {
            return;
        }
        var json = {
            "control_name": controlName,
            "selected_values": []
        };
        json.selected_values.push({
            "title": (title == '' ? value : title),
            "value": value,
            "url": url,
            "description": description
        });
        return JSON.stringify(json);
    }

 // For Chat Multi-Button on select
    $(d).on("click", "#multi-button-list > li", function() {
        if ($("input[name=chat-checkbox]:checked").length > 0) {
            $('.lc-submit-button').removeClass("lc-disable-btn");
        } else {
            $('.lc-submit-button').addClass("lc-disable-btn");
        }
    });

    // Sending message on press enter key
    $(d).on("keypress", ".lc-text-message", function(e) {
        if (e.which == 13) {
            var text = $(this).val();
            var uuid = $(this).attr("data-uuid");
            if (uuid &&  messages[uuid].data_control == 'address') {
                return;
            }
            if (text == null || text.trim() == "") {
                e.preventDefault();
                return;
            }
            replyMessage(uuid);
            e.preventDefault();
        }
    });

    $(d).on("keyup", ".lc-list-search", function() {
        var searchText = this.value;
        var searchRegex = new RegExp(searchText, "i");
        var hasFilter = searchText.length > 0;
        var $list = $(".lc-data-list");

        $list.toggleClass("lc-filtered", hasFilter);

        $list.find("li").each(function(i, el) {
            var $el = $(el)
            var elText = $el.text();
            var match = searchRegex.test(elText);

            $el.toggleClass("lc-found", match)
        })
        var found = $(".lc-data-list li.lc-found").length;
        if (found == '0') {
            $('.lc-list-empty').removeClass('lc-hide');
        } else {
            $('.lc-list-empty').addClass('lc-hide');
        }
    });

    $(d).on("click", ".lc-submit-button", function() {
        var uuid = $(this).attr("data-uuid");
        replyMessage(uuid);
    });

    $(d).on("click", ".lc-send-button", function() {
        if($('#lc-tel-box').val() != '' || $('#lc-text-box').val() != '') {
            var uuid = $('.lc-text-message').attr("data-uuid");
            replyMessage(uuid);
        }
    });

    function replyMessage(messageKey) {
        if (messageKey) {
            switch (messages[messageKey].data_control) {
                case "multi-button":
                    replyMultiButtonMessage();
                    break;
                case "multi-select":
                case "checkbox":
                    replyMultiSelectionMessage();
                    break;
                case "single-select":
                    break;
                case "name":
                case "telephone":
                case "address":
                case "password":
                case "email":
                case "number":
                case "mobile-number":
                case "full-name":
                case "age":
                case "star-rating":
                case "carousel":
                    replyDataControlMessage();
                    break;
                case "date":
                    replyDateMessage();
                    break;
                case "time":
                    replyTimeMessage();
                    break;
                default:
                    replyTextMessage();
            }
        } else {
            replyTextMessage();
        }
        manageTextBox(disableTextbox);
    }

    function replyMultiButtonMessage() {
        if ($("input[name=chat-checkbox]:checked").length > 0) {
            var uuid = $('#multi-button-list li').attr("data-uuid");
            var values = [];
            var displayNames = [];
            $('.lc-checkboxbtn').each(function() {
                if ($(this).is(":checked") == true) {
                    var value = $(this).attr('value');
                    var displayName = $(this).attr("data-name");
                    if ($.inArray(value, values) == -1) {
                        values.push(value);
                    }
                    if ($.inArray(displayName, displayNames) == -1) {
                        displayNames.push(displayName);
                    }
                }
            });
            sendMessage(createJSON(messages[uuid].data_control, displayNames, values), 'TEXT', 'SEND_MESSAGE', false);
            resetDataControl(uuid);
        }
    }

    function replyMultiSelectionMessage() {
        var values = $('input[name=chat-checkbox]:checked');
        var displayName = $('input[name=chat-checkbox]:checked').parent();
        var uuid = $('#multi-selection-list li').attr("data-uuid");
        if (values.length > 0) {
            var checkedValues = [];
            values.each(function() {
                checkedValues.push($(this).val());
            });
            var checkedDN = [];
            displayName.each(function() {
                checkedDN.push($(this).text().trim());
            });
            sendMessage(createJSON(messages[uuid].data_control, checkedDN, checkedValues), 'TEXT', 'SEND_MESSAGE', false);
            resetDataControl(uuid);
        }
    }

    function replyDateMessage() {
        if (lcAppointmentDate == null) {
            return;
        }
        var uuid = $('#lc-calendar').attr("data-uuid");
        sendMessage(createJSON(messages[uuid].data_control, lcAppointmentDate, lcAppointmentDate), 'TEXT', 'SEND_MESSAGE', false);
        handleRepeatedMessage(uuid);
        resetDataControl(uuid);
    }

    function replyTimeMessage() {
        if (lcAppointmentTime == null) {
            var hour = $("#lc-time-hour").children("option:selected").val();
            var minute = $("#lc-time-minute").children("option:selected").val();
            var period = $('.lc-time-period').text();
            lcAppointmentTime = hour + ':' + minute + ' ' + period;
        }
        var uuid = $('.lc-time-slot-popup').attr("data-uuid");
        sendMessage(createJSON(messages[uuid].data_control, lcAppointmentTime, lcAppointmentTime), 'TEXT', 'SEND_MESSAGE', false);
        handleRepeatedMessage(uuid);
        resetDataControl(uuid);
    }

    function createJSON(controlName, displayName, value) {
        if ($.isEmptyObject(value)) {
            return;
        }
        var json = {
            "control_name": controlName,
            "selected_values": []
        };
        if ($.isArray(displayName)) {
            for (var i = 0; i < value.length; i++) {
                json.selected_values.push({
                    "dn": getDisplayName(displayName, i),
                    "value": value[i]
                });
            }
        } else {
            json.selected_values.push({
                "dn": (displayName == '' ? value : displayName),
                "value": value
            });
        }
        return JSON.stringify(json);
    }

    function getDisplayName(displayName, index) {
        if ($.isArray(displayName)) {
            return displayName[index];
        }
    }

    function replyDataControlMessage() {
        $('.lc-text-message').each(function() {
            var uuid = $(this).attr("data-uuid");
            if (uuid && messages[uuid].data_control) {
                var dn = '';
                var value = $(this).val();
                if (value.trim() == '') {
                    return;
                }
                if (messages[uuid].data_control == 'password') {
                    dn = convertPasswordToStar(value);
                }
                if(messages[uuid].data_control == 'carousel') {
                    sendMessage(createJSONForCarousel(messages[uuid].data_control, title, value.trim(), url, description), 'TEXT', 'SEND_MESSAGE', false);
                }
                sendMessage(createJSON(messages[uuid].data_control, dn, value.trim()), 'TEXT', 'SEND_MESSAGE', false);
                repeatedMessage = false;
                resetDataControl(uuid);
            }
        });
    }

    function replyTextMessage() {
        $('.lc-text-message').each(function() {
            sendMessage($(this).val(), 'TEXT', 'SEND_MESSAGE', false);
            $(this).val("");
            $(".lc-send-button").removeClass("lc-active-send-btn");
            repeatedMessage = false;
        });
    }

    function isCarouselExists() {
        if ($('.carousel-list:last').length) {
            return true;
        }
        return false;
    }

    function disableLastCarouselIfExists() {
        if (isCarouselExists() && !$('.carousel-list:last').find(".cta-btn-select").hasClass("lc-disabled")) {
            $('.carousel-list:last').find(".cta-btn-select").addClass("lc-disabled");
        }
    }

    function resetDataControl(messageKey) {
        $('#lc-tel-box').attr("type", "text");
        $('#lc-tel-box').show();
        $('#lc-text-box').hide();
        $('#lc-data-container').empty();
        $('#lc-data-container').fadeIn();
        disableLastCarouselIfExists();
        $(".lc-text-message").val("");
        $('.lc-text-message').removeClass("lcDigitsOnly");
        $('.lc-text-message').removeClass("lcNoSpace");
        $('.lc-text-message').removeClass("lc-password");
        $('.lc-text-message-outer').removeClass("lc-address-bar");
        $(".lc-send-button").removeClass("lc-active-send-btn");
        $('.lc-text-message').attr("placeholder", "Type message...");
        if (messageKey) {
            $('.lc-text-message').removeAttr("data-uuid");
            delete messages[messageKey];
        }
        isResetState = false;
        scrollHeight();
    }

    $(w).bind('resize', function() {
        scrollHeight();
    });

    function manageSelectionList() {
        var header_height = $('.data-control-list-header').height();
        if (header_height > 40) {
            $('.data-control-list').css({
                'height': (($('.data-control-list').height()) - (header_height - 40)) + 'px'
            });
        }
    }

    function uuidv4() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0,
                v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    function focusTextMessage() {
        $(".lc-text-message").focus();
    }

    function removeFocusTextMessage() {
        $(".lc-text-message").blur();
    }

    function convertPasswordToStar(pass) {
        var text = "";
        for (var i = 0; i < pass.length; i++) {
            text += "*";
        }
        return text;
    }

    function getURLParameterAndCookies() {
        var result = {};
        try {
            var parentUrl = new URL(hostUrl);
            var params = new URLSearchParams(parentUrl.search);
            for (var param of params) {
                result[param[0]] = param[1];
                result["url.query_param." + param[0]] = param[1];
            }
            result["href"] = parentUrl.href;
            result["origin"] = parentUrl.origin;
            result["host"] = parentUrl.host;
            result["hostname"] = parentUrl.hostname;
            result["pathname"] = parentUrl.pathname;
            result["hash"] = parentUrl.hash;
            result["protocol"] = parentUrl.protocol;
            //new naming conventions
            result["url.href"] = parentUrl.href;
            result["url.origin"] = parentUrl.origin;
            result["url.host"] = parentUrl.host;
            result["url.hostname"] = parentUrl.hostname;
            result["url.pathname"] = parentUrl.pathname;
            result["url.hash"] = parentUrl.hash;
            result["url.protocol"] = parentUrl.protocol;
            for (var name in hostCookies) {
                result["cookie." + name] = hostCookies[name];
            }
        } catch (e) {
            console.error(e);
        }
        return result;
    }

    function sendMessage(messageText, messageType, event, resetState) {
        if (!resetState) {
            if (messageText == null || messageText.trim() == "") {
                return;
            }
        }
        if (appId == null || appId == "") {
            return;
        }
        client.send("/app/livechat/" + appId + "-" + userId, {}, JSON.stringify({
            uid: userId,
            appId: appId,
            incoming: true,
            ts: new Date().getTime(),
            event: event,
            reset_state: resetState,
            request_params: getURLParameterAndCookies(),
            preview: preview,
            preview_workflow_id: previewWorkflowId,
            liveChatMessageInfo: {
                text: messageText,
                type: messageType
            }
        }));
    }

    $('.continue-conversation').click(function() {
        continueConversation();
    });
    
    function continueConversation() {
        $('.lc-load-history').remove();
        $('#lc-chat-window').removeClass("hidden");
        callAnalytics("Continue Conversation");
        hideDashboard();
        scrollHeight();
    }

    $('.new-conversation').click(function() {
        newConversation();
    });
    
    function newConversation() {
        resetDataControl();
        manageTextBox(false);
        isResetState = true;
        repeatedMessage = false;
        if ($("#lc-chat-window").find('.lc-message-sent').length > 0) {
            $('.lc-load-history').remove();
            $('#lc-chat-window > div').addClass('history');
            $('#lc-chat-window').addClass("hidden");
            $('#lc-chat-window').append(loadHistory);
        }
        $('#lc-data-container').empty();
        $('#lc-data-container').fadeIn();
        startConversation();
    }

    function startConversation() {
        callAnalytics("New Conversation");
        sendMessage('Start new conversation', 'TEXT', 'CHAT_START', true);
        if (isWelcomeEventCall === 'false') {
            var welcome_msg = {
                "uid": userId,
                "liveChatMessageInfo": {
                    "text": null,
                    "type": "TEXT"
                },
                "incoming": false,
                "appId": appId,
                "ts": new Date(),
                "data_control": null,
                "data_source": null
            }

            var wms = getLcWms();
            if (!$.isEmptyObject(wms)) {
                var i = 0;
                var msg = Object.create(welcome_msg);

                function sendLcWm() {
                    msg.liveChatMessageInfo.text = wms[i];
                    if (i === (wms.length - 1)) {
                        sendLcWmo(msg);
                    } else {
                        showMessage(msg);
                    }
                    setTimeout(function() {
                        i++;
                        if (i < wms.length) {
                            sendLcWm();
                        }
                    }, 3000)
                }
                sendLcWm();
            }
        }
        hideDashboard();
        scrollHeight();
    }

    function sendLcWmo(message) {
        var msg = Object.create(message);
        var wmo = getLcWmo();
        if (!$.isEmptyObject(wmo)) {
            var list = [];
            for (var i in wmo) {
                list.push({
                    "value": wmo[i],
                    "dn": wmo[i]
                })
            }
            msg.data_control = "button";
            msg.data_source = {
                "type": "static",
                "list": list
            };
            showMessage(msg);
        }
    }

    $('.lc-reset').click(function() {
        showDashboard();
    });

    function getLcWmo() {
        var wmo = [];
        $(".welcome_message_options").each(function() {
            wmo.push($(this).val());
        });
        return wmo;
    }

    function getLcWms() {
        var wms = [];
        $(".welcome_messages").each(function() {
            wms.push($(this).val());
        });
        return wms;
    }

    function connectLiveChat() {
        if ($("#lc-chat-window").find('.lc-message-received').length == 0 && $("#lc-chat-window").find('.lc-message-sent').length == 0) {
            isResetState = true;
            hideDashboard();
            startConversation();
        } else if (isMinimized) {
            isMinimized = false;
            continueConversation();
        } else {
            checkUserSession();
        }
    }

    function checkUserSession() {
    	var lastOutgoingMessage = null;
    	try {
    		lastOutgoingMessage = JSON.parse(localStorage.getItem('last_outgoing_msg_' + appId));
        } catch (err) {
            console.log('Cannot read last_outgoing_msg_ from local storage');
        }
        if(lastOutgoingMessage != null) {
            var lastMsgTimestamp = Date.parse(lastOutgoingMessage.ts);
            var currentTime = (new Date()).getTime();
            if((lastMsgTimestamp + 86400000) <= currentTime) {
                newConversation();
            } else if (!lastOutgoingMessage.is_workflow_message && !lastOutgoingMessage.is_last_node) {
                continueConversation();
            } else if (lastOutgoingMessage.is_workflow_message && lastOutgoingMessage.is_last_node) {
                newConversation();
            } else if (lastOutgoingMessage.is_workflow_message && !lastOutgoingMessage.is_last_node && lastOutgoingMessage.data_control != null) {
                continueConversation();
                repeatedMessage = true;
                showMessage(lastOutgoingMessage);
            } else {
                continueConversation();
            }
        } else {
            newConversation();
        }
    }

    function handleRepeatedMessage(uuid) {
        if(!repeatedMessage) {
            $('#lc-chat-window').append(showTextMessage(messages[uuid]));
        } else {
            repeatedMessage = false;
        }
    }

    function showDashboard() {
        $('#lc-chat-textbox').hide();
        $('#lc-data-container').hide();
        $('#lc-message-dashboard').fadeIn();
    }

    function hideDashboard() {
        $('#lc-message-dashboard').hide();
        $('#lc-chat-textbox').fadeIn();
        $('#lc-data-container').show();
    }

    function showLoading() {
        $('#lc-chat-window').append(loading);
        scrollHeight();
    }

    function hideLoading() {
        $('#loading').remove();
        scrollHeight();
    }

    function scrollHeight() {
        $('.lc-messages-content').scrollTop($('#lc-chat-window').height());
    }

    function connectLiveChatForVideoCall(msg) {
        nativeDepartmentId = msg.department_id;
        nativeDepartmentName = msg.department_name;
        connectLiveChat();
        startVideoCall();
        sendMessage('CHAT_OPEN', 'TEXT', 'CHAT_OPEN', true);
        callAnalytics("Video Call");
    }

    function lcCloseIframe() {
        var msg = {
            "action": "CLOSE_IFRAME"
        };
        // Sending message to parent to video call ring
        w.parent.postMessage(JSON.stringify(msg), '*');
    }

    function callRingAlert(type) {
        var msg = {
            "action": type
        };
        // Sending message to parent to video call ring
        w.parent.postMessage(JSON.stringify(msg), '*');
    }

    function callAnalytics(label) {
        var msg = {
            "action": "CALLANALYTICS",
            "data": {
                "category": "BotsDekho",
                "action": "LiveChat",
                "label": label
            }
        };
        // Sending message to parent to call analytics
        w.parent.postMessage(JSON.stringify(msg), '*');
    }

    // addEventListener support for IE8
    function bindEvent(element, eventName, eventHandler) {
        if (element.addEventListener) {
            element.addEventListener(eventName, eventHandler, false);
        } else if (element.attachEvent) {
            element.attachEvent('on' + eventName, eventHandler);
        }
    }

    // Listen to message from parent
    bindEvent(window, 'message', function(e) {
        var msg = JSON.parse(e.data);
        if (msg == null) {
            return;
        }

        switch (msg.action) {
        case 'CONNECT':
            copyCookies(msg.cookies);
            updateHostUrl(msg.location);
            connectSockJS(function() {connectLiveChat();});
            break;
        case 'VIDEOCALL':
            connectSockJS(function() {connectLiveChatForVideoCall(msg);});
            break;
        case 'LOCATION_CHANGE':
            copyCookies(msg.cookies);
            updateHostUrl(msg.location);
            break;
        case 'PREVIEW':
            preview = true;
            previewWorkflowId = msg.previewWorkflowId;
            connectSockJS(function() {connectLiveChat();});
            break;
        default:
    }
    });

    // localStorage
    function getObject(key) {
        var value = localStorage.getItem(key);
        return value && JSON.parse(value);
    }

    function updateHostUrl(location) {
        hostUrl = location;
    }

    function copyCookies(cookies) {
        hostCookies = [];
        var cookiesArr = cookies.split(";");
        for (var i in cookiesArr) {
            var cookie = cookiesArr[i].trim();
            var name = cookie.substring(0, cookie.indexOf("="));
            var value = cookie.substring(cookie.indexOf("=") + 1, cookie.length);
            hostCookies[name] = value;
        }
    }

    $(document).on("click","#lc-chat-window, .lc-welback-box.lc-welfixed-bottom.lc-full-card-view.lc-choose-options, .lc-welback-box.lc-welfixed-bottom.lc-suggest-wrap",function(){
        if(($(event.target).hasClass('lc-welback-box') && $(event.target).hasClass('lc-welfixed-bottom') && $(event.target).hasClass('lc-full-card-view') && $(event.target).hasClass('lc-choose-options'))
        || ($(event.target).hasClass('lc-message') && $(event.target).hasClass('lc-message-received') && $(event.target).hasClass('lc-fade-in'))
        || ($(event.target).hasClass('lc-message') && $(event.target).hasClass('lc-message-sent') && $(event.target).hasClass('lc-blueclr-msg') && $(event.target).hasClass('lc-fade-in'))
        || ($(event.target).hasClass('lc-welback-box') && $(event.target).hasClass('lc-welfixed-bottom') && $(event.target).hasClass('lc-suggest-wrap'))) {
        $("#lc-multi-select").hide();
        $("#lc-single-select").hide();
        }
    });

    $(document).on("click", ".single-list-optns", function() {
        if ($('#lc-single-select').is(':hidden') && $("#lc-single-select").hasClass('fadeInDown')) {
             $(".lc-drag").trigger("click");
        }
        $("#lc-single-select").toggle();
    });

    $(document).on("click",".multi-list-optns",function(){
        if ($('#lc-multi-select').is(':hidden') && $("#lc-multi-select").hasClass('fadeInDown')) {
            $(".lc-drag").trigger("click");
        }
        $("#lc-multi-select").toggle();
    });

    $(document).on("click",".multi-btn-optns",function(){
        if($('#lc-multi-select').is(':hidden')) {
            $(".multi-btn-ul").css("height", "auto");
            if($("#lc-multi-select").hasClass('fadeInDown')) {
                $(".lc-drag").trigger("click");
            }
        }
        $("#lc-multi-select").toggle();
    });

});